<!DOCTYPE html>
<html lang="en" color-mode="light">

  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <meta name="keywords" content="GPU Intel Performance">
  
  <meta name="author" content="Cris Bai" />
  <meta name="description" content="" />
  
  
  <title>
    
      C++ Allocator 
      
      
      |
    
     Cris Bai&#39;s Blog
  </title>

  
    <link rel="apple-touch-icon" href="/images/favicon.png">
    <link rel="icon" href="/images/favicon.png">
  

  <!-- Raleway-Font -->
  <link href="https://fonts.googleapis.com/css?family=Raleway&display=swap" rel="stylesheet">

  <!-- hexo site css -->
  <link rel="stylesheet" href="/css/main.css" />
  <link rel="stylesheet" href="//at.alicdn.com/t/font_1886449_67xjft27j1l.css" />
  <!-- ä»£ç å—é£æ ¼ -->
  

  <!-- jquery3.3.1 -->
  
    <script defer type="text/javascript" src="/plugins/jquery.min.js"></script>
  

  <!-- fancybox -->
  
    <link href="/plugins/jquery.fancybox.min.css" rel="stylesheet">
    <script defer type="text/javascript" src="/plugins/jquery.fancybox.min.js"></script>
  
  
<script src="/js/fancybox.js"></script>


  

  

  <script>
    var html = document.documentElement
    const colorMode = localStorage.getItem('color-mode')
    if (colorMode) {
      document.documentElement.setAttribute('color-mode', colorMode)
    }
  </script>
<meta name="generator" content="Hexo 6.3.0"></head>


  <body>
    <div id="app">
      <div class="header">
  <div class="avatar">
    <a href="/">
      <!-- å¤´åƒå–æ¶ˆæ‡’åŠ è½½ï¼Œæ·»åŠ no-lazy -->
      
        <img src="/images/avatar.png" alt="">
      
    </a>
    <div class="nickname"><a href="/">Oranges</a></div>
  </div>
  <div class="navbar">
    <ul>
      
        <li class="nav-item" data-path="/">
          <a href="/">Home</a>
        </li>
      
        <li class="nav-item" data-path="/archives/">
          <a href="/archives/">Archives</a>
        </li>
      
        <li class="nav-item" data-path="/tags/">
          <a href="/tags/">Tags</a>
        </li>
      
        <li class="nav-item" data-path="/toolkit/">
          <a href="/toolkit/">Toolkit</a>
        </li>
      
        <li class="nav-item" data-path="/about/">
          <a href="/about/">About</a>
        </li>
      
    </ul>
  </div>
</div>


<script src="/js/activeNav.js"></script>



      <div class="flex-container">
        <!-- æ–‡ç« è¯¦æƒ…é¡µï¼Œå±•ç¤ºæ–‡ç« å…·ä½“å†…å®¹ï¼Œurlå½¢å¼ï¼šhttps://yoursite/æ–‡ç« æ ‡é¢˜/ -->
<!-- åŒæ—¶ä¸ºã€Œæ ‡ç­¾tagã€ï¼Œã€Œæœ‹å‹friendã€ï¼Œã€Œåˆ†ç±»categoriesã€ï¼Œã€Œå…³äºaboutã€é¡µé¢çš„æ‰¿è½½é¡µé¢ï¼Œå…·ä½“å±•ç¤ºå–å†³äºpage.type -->


  <!-- LaTex Display -->

  
    <script async type="text/javascript" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
  
  <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      }
    }
  </script>





  <!-- clipboard -->

  
    <script async type="text/javascript" src="/plugins/clipboard.min.js"></script>
  
  
<script src="/js/codeCopy.js"></script>







  

  

  

  
  <!-- æ–‡ç« å†…å®¹é¡µ urlå½¢å¼ï¼šhttps://yoursite/æ–‡ç« æ ‡é¢˜/ -->
  <div class="container post-details" id="post-details">
    <div class="post-content">
      <div class="post-title">C++ Allocator</div>
      <div class="post-attach">
        <span class="post-pubtime">
          <i class="iconfont icon-updatetime mr-10" title="Update time"></i>
          2024-06-12 21:19:21
        </span>
        
              <span class="post-tags">
                <i class="iconfont icon-tags mr-10" title="Tags"></i>
                
                <span class="span--tag mr-8">
                  <a href="/tags/Modern-C/" title="Modern C++">
                    #Modern C++
                  </a>
                </span>
                
                <span class="span--tag mr-8">
                  <a href="/tags/Memory-manage/" title="Memory manage">
                    #Memory manage
                  </a>
                </span>
                
              </span>
          
      </div>
      <div class="markdown-body">
        <h2 id="C-æ ‡å‡†åº“å†…å­˜åˆ†é…å™¨å’Œå†…å­˜åˆ†é…å™¨ç‰¹æ€§"><a href="#C-æ ‡å‡†åº“å†…å­˜åˆ†é…å™¨å’Œå†…å­˜åˆ†é…å™¨ç‰¹æ€§" class="headerlink" title="C++ æ ‡å‡†åº“å†…å­˜åˆ†é…å™¨å’Œå†…å­˜åˆ†é…å™¨ç‰¹æ€§"></a>C++ æ ‡å‡†åº“å†…å­˜åˆ†é…å™¨å’Œå†…å­˜åˆ†é…å™¨ç‰¹æ€§</h2><h3 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h3><p>åœ¨æˆ‘ä»¬æ—¥å¸¸ä½¿ç”¨C++ STLå®¹å™¨ç±»æ¯”å¦‚<code>std::vector</code>æ—¶ï¼Œç»†å¿ƒçš„åŒå­¦ä¼šæ³¨æ„åˆ°ï¼Œ<code>std::vector</code>çš„æ¨¡æ¿å‚æ•°å¹¶ä¸æ˜¯åªæœ‰ä¸€ä¸ªå…ƒç´ ç±»å‹ï¼Œè€Œæ˜¯ç±»ä¼¼äºï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">std::vector&lt;<span class="keyword">typename</span> _Ty, <span class="keyword">typename</span> _Alloc = std::allocator &lt; _Ty &gt;&gt;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬çŸ¥é“ï¼Œå‰é¢çš„æ¨¡æ¿å‚æ•° <code>_Ty</code> ä»£è¡¨äº†è¯¥å®¹å™¨çš„å…ƒç´ ç±»å‹ï¼Œé‚£ä¹ˆè¿™ä¸ª<code>allocator</code>æ˜¯åšä»€ä¹ˆçš„ï¼Œæˆ‘ä»¬ä»€ä¹ˆæ—¶å€™è¯¥ä½¿ç”¨å®ƒå‘¢ï¼Ÿ</p>
<h3 id="å†å²"><a href="#å†å²" class="headerlink" title="å†å²"></a>å†å²</h3><p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Allocator_%28C%2B%2B%29">Allocator C++ from wikipedia</a> è¯¥é¡µä»‹ç»äº†ä¸€äº›allocatorçš„å‘å±•ã€‚ä»æœ€å¼€å§‹<code>allocator</code>çš„ä½œè€…çš„æ„å›¾å°±æ˜¯å¸Œæœ›å°†å®¹å™¨è¡Œä¸ºå’Œåº•å±‚å­˜å‚¨æ¨¡å‹è§£è€¦ï¼Œè¿™ä½¿å¾—æ ‡å‡†åº“å®¹å™¨å¯ä»¥åœ¨æ›´å¹¿æ³›çš„é¢†åŸŸå‘æŒ¥ä½œç”¨ï¼Œè€Œå±è”½å®¹å™¨ä½¿ç”¨è€…å¯¹åº•å±‚å†…å­˜æ¨¡å‹çš„æ„ŸçŸ¥ï¼Œè¿›ä¸€æ­¥æé«˜äº†å°è£…æ€§ã€‚</p>
<p>å…¶å®å¾ˆå°‘æœ‰å…¬å¸æˆ–è€…é¡¹ç›®éœ€è¦ç¨‹åºè®¾è®¡è€…çœŸæ­£çš„å»æ”¹å˜ç”šè‡³è‡ªå®šä¹‰å†…å­˜åˆ†é…å™¨ï¼Œå› ä¸ºè¿™é€šå¸¸æ„å‘³ç€éš¾äºç»´æŠ¤å¹¶å‡å°‘äº†å¯æ‰©å±•æ€§å’Œé€šç”¨æ€§ï¼Œä½†æ˜¯åœ¨å¼‚æ„è®¡ç®—é£é€Ÿå‘å±•çš„ä»Šå¤©ï¼Œåº•å±‚æ•°æ®ä¸ä»…ä»…æ¥æºäºæ™®é€šçš„<code>new</code>å’Œ<code>delete</code>ï¼Œè€Œæ˜¯å¯èƒ½é€šè¿‡å„ç§ç‰¹æ®Šçš„APIè®¿é—®ä¸åŒä»‹è´¨ä¸Šçš„å­˜å‚¨ç©ºé—´ï¼Œæ¯”å¦‚æ˜¾å­˜æˆ–è€…ç¥ç»ç½‘ç»œåŠ é€Ÿå™¨çš„ç‰‡ä¸Šå­˜å‚¨ã€‚é€šå¸¸ï¼Œè¿™äº›å­˜å‚¨çš„åˆ†é…å¹¶ä¸èƒ½é€šè¿‡C++æ ‡å‡†åº“æ¥å¾—åˆ°ï¼Œè€Œæ˜¯ç”±ä¸“æœ‰APIç®¡ç†ï¼Œé‚£ä¹ˆå¦‚æœæˆ‘ä»¬å¸Œæœ›åœ¨è¿™äº›å­˜å‚¨ä¸Šåˆ†é…æ ‡å‡†åº“å®¹å™¨æˆ–å…¶ä»–è‡ªå®šä¹‰å®¹å™¨æ—¶ï¼Œä¸€ä¸ªçµæ´»çš„<code>allocator</code>æœºåˆ¶å°±æ˜¾å¾—æ ¼å¤–é‡è¦äº†ã€‚</p>
<h3 id="ä¼˜åŠ¿"><a href="#ä¼˜åŠ¿" class="headerlink" title="ä¼˜åŠ¿"></a>ä¼˜åŠ¿</h3><p>é‡‡ç”¨è¡Œä¸ºå’Œå­˜å‚¨åˆ†ç¦»çš„<code>allocator</code>è®¾è®¡æ¨¡å¼æœ‰å¾ˆå¤šå¥½å¤„ã€‚æ¯”å¦‚ï¼š</p>
<ol>
<li>ä½¿ç®—æ³•é€»è¾‘å’Œåº•å±‚å­˜å‚¨çš„å®ç°ç›¸åˆ†ç¦»ï¼Œè¿™é€šå¸¸å¯¹ç®—æ³•ä»¿çœŸéå¸¸å‹å¥½ï¼Œç”¨æˆ·å¯ä»¥åœ¨æ™®é€šDDRä¸Šå®Œæˆç®—æ³•çš„è®¾è®¡å’ŒéªŒè¯ï¼Œè€Œåœ¨çœŸæ­£çš„åŠ é€Ÿå™¨ä¸Šå»åšéƒ¨ç½²ï¼Œå¦‚æœæ²¡æœ‰ä¸€ä¸ªç‹¬ç«‹çš„<code>allocator</code>æœºåˆ¶ï¼Œé‚£ä¹ˆç¹ççš„æ•°æ®å­˜å‚¨ç®¡ç†ï¼Œæ¬ç§»å°†å˜å¾—éå¸¸éº»çƒ¦ã€‚</li>
<li>å°½å¯èƒ½çš„åˆ©ç”¨ç°æœ‰çš„<code>STL</code>åŸºç¡€è®¾æ–½ï¼Œå¦‚æœç”¨æˆ·è®¾è®¡çš„<code>allocator</code>å…¼å®¹æ ‡å‡†åº“ä¸­çš„<code>std::allocator_traits</code>ï¼Œé‚£å°±æ„å‘³ç€æ ‡å‡†åº“ä¸­çš„å¤§éƒ¨åˆ†å®¹å™¨å¯ä»¥ç›´æ¥éƒ¨ç½²åœ¨è¯¥åˆ†é…å™¨ä¸Šï¼Œè€Œå¯¹äºå®¹å™¨ä½¿ç”¨è€…æ¥è¯´ï¼Œè¿™ä¸æ™®é€šï¼ˆé»˜è®¤ï¼‰åˆ†é…å™¨çš„è¡Œä¸ºåˆ«æ— äºŒè‡´ã€‚</li>
<li>å¢å¼ºæ€§èƒ½ã€‚åœ¨å¼‚æ„è®¡ç®—é¢†åŸŸä¹‹å¤–ï¼Œå¾ˆå¤šé¡¹ç›®éƒ½é‡‡ç”¨äº†è‡ªå®šä¹‰åˆ†é…å™¨æ¥åŠ é€Ÿç¨‹åºæé«˜æ€§èƒ½ï¼Œå…¸å‹çš„çŠ¶å†µå¯èƒ½æœ‰ï¼š<ol>
<li>è¯¥é¡¹ç›®ä½¿ç”¨äº†ä¸€ä¸ªè‡ªå·±è®¾è®¡çš„å†…å­˜æ± æ¥åŠ é€Ÿå†…å­˜åˆ†é…å’Œé‡Šæ”¾ï¼Œä¸ºäº†ä½¿ç”¨è¯¥å†…å­˜æ± åˆ†é…å®¹å™¨ï¼Œéœ€è¦è‡ªå®šä¹‰åˆ†é…å™¨å°†å­˜å‚¨é€»è¾‘è½¬ç§»åˆ°è‡ªå®šä¹‰å†…å­˜æ± ä¸Š</li>
<li>è¯¥é¡¹ç›®æœ‰ä¸€äº›ç‰¹æ®Šæƒ…å†µå¹¶ä¸å¸Œæœ›ä¸€å®šåœ¨å †ä¸Šåˆ†é…å†…å­˜ï¼Œæ¯”å¦‚ç±»ä¼¼åœ¨<code>std::string</code>ä¸­æ‰€é‡‡ç”¨çš„å°å¯¹è±¡ä¼˜åŒ–ï¼ˆåœ¨é•¿åº¦ä½äº16å­—èŠ‚æ—¶ï¼Œç›´æ¥ä½¿ç”¨å†…ç½®çš„æ ˆå†…å­˜ï¼‰</li>
<li>è¯¥é¡¹ç›®ä½¿ç”¨äº†ä¸€äº›å…±äº«å†…å­˜æŠ€æœ¯ï¼Œä¸å¸Œæœ›å®¹å™¨çš„æ•°æ®åœ¨å¯å…±äº«çš„æ¡ä»¶ä¸‹ä¾ç„¶é‡‡ç”¨å¤åˆ¶</li>
</ol>
</li>
</ol>
<h3 id="å¦‚ä½•å…¥æ‰‹"><a href="#å¦‚ä½•å…¥æ‰‹" class="headerlink" title="å¦‚ä½•å…¥æ‰‹"></a>å¦‚ä½•å…¥æ‰‹</h3><ol>
<li>æ˜ç¡®éœ€æ±‚ï¼šé¦–å…ˆ<code>allocator</code>çš„è®¾è®¡æ¨¡å¼æ˜¯ä¸€ç§æ€æƒ³ï¼Œè¦å…ˆåˆ¤æ–­åœ¨é¡¹ç›®ä¸­æ˜¯å¦çœŸçš„éœ€è¦å¯¹å†…å­˜çš„åˆ†é…é‡Šæ”¾è¿›è¡ŒæŠ½è±¡ï¼Œåœ¨å¾ˆå¤šæƒ…å†µä¸‹ï¼Œç›´æŠ’èƒ¸è‡†çš„ä»£ç å¯èƒ½æ›´å®¹æ˜“ç»´æŠ¤ï¼Œå’Œå‡å°‘éšè—çš„å†…å­˜é—®é¢˜ã€‚</li>
<li>æ˜¯å¦è¦å…¼å®¹æ ‡å‡†åº“ï¼Œç”±äºç›®å‰C++çš„å‘å±•ä¸»è¦ç”±å‡ å®¶å…¬å¸æ¥ä¸»å¯¼ï¼Œè€ŒC++æ ‡å‡†å§”å‘˜ä¼šå¹¶æ²¡æœ‰è¦æ±‚æ ‡å‡†åº“æœ‰ç»Ÿä¸€çš„å®ç°ï¼Œå› æ­¤è¦è®¾è®¡ä¸€ä¸ªè·¨å¹³å°è·¨ç¼–è¯‘å™¨åŒæ—¶å…¼å®¹æ ‡å‡†åº“çš„åˆ†é…å™¨å¹¶ä¸æ˜¯å¾ˆå®¹æ˜“ï¼Œå¦‚æœé¡¹ç›®å¯¹æ ‡å‡†åº“åˆ†é…å™¨æ²¡æœ‰å¾ˆå¼ºçš„å®šåˆ¶éœ€æ±‚ï¼Œé‚£ä¹ˆåˆ†é…å™¨ä¸åº”è¯¥å¼ºè¡ŒåŒ¹é…æ ‡å‡†åº“è¡Œä¸ºï¼Œè¿™ä¼šå¸¦æ¥ä¸€äº›é¢å¤–çš„å·¥ä½œé‡ã€‚</li>
<li>ä½†æ˜¯ï¼Œå­¦ä¹ æ ‡å‡†åº“çš„<code>std::allocator_traits</code>æ˜¯ä¸€ä¸ªä¸é”™çš„å…¥æ‰‹çš„ä¾‹å­ï¼Œæ¥æŒ‡å¯¼å®Œæˆä¸€ä¸ªé€»è¾‘è‡ªæ´½çš„å†…å­˜åˆ†é…å™¨ï¼Œæ‚¨å¯èƒ½ä¸éœ€è¦å®ç°å…¶ä¸­çš„æ¯ä¸€ä¸ªç»†èŠ‚ï¼Œä½†æ˜¯åœ¨å­¦ä¹ çš„è¿‡ç¨‹ä¸­ï¼Œæ ‡å‡†åº“æ‰€è€ƒè™‘çš„é—®é¢˜ä¸€å®šä¼šç»™æ‚¨çš„é¡¹ç›®å¸¦æ¥ä¸€äº›æç¤ºï¼Œè®©ä½ å°‘èµ°å¼¯è·¯ã€‚</li>
</ol>
<h3 id="ä»C-17-std-allocator-traits-å‡ºå‘"><a href="#ä»C-17-std-allocator-traits-å‡ºå‘" class="headerlink" title="ä»C++17 std::allocator_traits å‡ºå‘"></a>ä»C++17 std::allocator_traits å‡ºå‘</h3><p>åœ¨é˜…è¯»å®Œ<code>allocator</code>çš„å†å²ä¹‹åï¼Œæˆ‘ä»¬ä¼šå‘ç°åœ¨å‘å±•çš„è¿‡ç¨‹ï¼Œå…¶è®¾è®¡æ€æƒ³å’Œç†å¿µå‘ç”Ÿäº†å¾ˆå¤§çš„å˜åŒ–ï¼Œæœ¬æ–‡åŸºäºC++17åŠä»¥ä¸Šæ ‡å‡†å±•å¼€è®¨è®ºã€‚</p>
<p><code>std::allocator_traits</code> æ˜¯æ ‡å‡†åº“å¯¹åˆ†é…å™¨æ¥å£çš„å®šä¹‰å’Œå°è£…ï¼Œæ ‡å‡†åº“å®¹å™¨å‡ä½¿ç”¨è¯¥traitçš„æ³›åŒ–ç±»å‹<code>std::allocator_traits&lt;YourAllocator&gt;</code>æ¥å¯¹æ ‡å‡†åº“å®¹å™¨è¿›è¡Œæ“ä½œï¼Œæ¥ä¿è¯å…¼å®¹æ€§å’Œä¸€è‡´æ€§ã€‚</p>
<p>åœ¨MSDNä¸Šï¼Œæœ‰ä¸€ç¯‡æ–‡ç« éå¸¸ç®€æ˜æ‰¼è¦çš„ä»‹ç»äº†å¦‚ä½•å†™ä¸€ä¸ªæœ€åŸºç¡€çš„åˆ†é…å™¨ï¼Œ<a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/cpp/standard-library/allocators?view=msvc-170">Allocators</a>ï¼Œå…¶ä¸­å¯¹C++11æ ‡å‡†å’ŒC++03æ ‡å‡†éƒ½æœ‰è®¨è®ºã€‚</p>
<p><a target="_blank" rel="noopener" href="https://en.cppreference.com/w/cpp/memory/allocator_traits">std::allocator_traits</a> è¿™é‡Œæ˜¯å®Œæ•´çš„ç‰¹æ€§å®šä¹‰ã€‚</p>
<p><a target="_blank" rel="noopener" href="https://isocpp.org/files/papers/N4860.pdf">C++ Draft International Standard</a> è¿™é‡Œæ˜¯C++æ ‡å‡†è‰æ¡ˆï¼Œè¯¥æ–‡æ¡£æ›´åŠ æ­£å¼å’Œå‡†ç¡®ã€‚</p>
<p>é€šç¯‡é˜…è¯»åï¼Œæˆ‘ä»¬ä¼šå‘ç°ï¼Œæœ‰ä¸€äº›å†…å®¹å’Œæˆ‘ä»¬é¢„æƒ³çš„ä¸€æ ·ï¼Œåˆ†é…å™¨åº”è¯¥æä¾›<code>allocate</code>, <code>deallocate</code>æ¥åˆ†é…å†…å­˜ï¼ŒåŒæ—¶ä¹Ÿæä¾›<code>construct</code>å’Œ<code>destroy</code>æ¥æ„å»ºå…ƒç´ å’Œææ„å…ƒç´ ã€‚</p>
<p>ä½†åŒæ—¶ä¹Ÿæœ‰ä¸€äº›è®©äººç¢ç£¨ä¸é€çš„æˆå‘˜ç±»å‹å’Œç±»å†…æ¨¡æ¿æ¯”å¦‚<code>is_always_equal</code>, <code>rebind_alloc&lt;T&gt;</code>ï¼Œä¸‹é¢æˆ‘ä»¬æ ¹æ®å‡ ä¸ªè¯é¢˜æ¥è®¨è®ºä¸€ä¸‹ã€‚</p>
<h3 id="è®¨è®º"><a href="#è®¨è®º" class="headerlink" title="è®¨è®º"></a>è®¨è®º</h3><ol>
<li><p><strong>åˆ†é…å™¨æ˜¯å¦éœ€è¦æœ‰çŠ¶æ€ï¼Ÿ</strong>ä¸å¾—ä¸è¯´å®ç°ä¸€ä¸ªæ— çŠ¶æ€çš„åˆ†é…å™¨è‚¯å®šæ˜¯è¦æ›´å®¹æ˜“çš„ï¼Œä½†é€šå¸¸æƒ…å†µä¸‹å®ç°è‡ªå®šä¹‰åˆ†é…å™¨çš„ç›®çš„å°±æ˜¯æƒ³åœ¨åˆ†é…å™¨å†…éƒ¨æºå¸¦ä¸€å®šçš„ä¿¡æ¯ã€‚åˆ†é…å™¨çš„çŠ¶æ€å¼•å‘äº†å…³äºç­‰ä»·æ€§çš„è®¨è®ºï¼Œå³ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¦‚æœ</span></span><br><span class="line">MyAllocator&lt;<span class="type">int</span>&gt; a, b;</span><br><span class="line"><span class="comment">// é‚£ä¹ˆ</span></span><br><span class="line"><span class="type">bool</span> compare = (a == b) ? <span class="literal">true</span> : <span class="literal">false</span>;</span><br></pre></td></tr></table></figure>
<p>å¦‚æœ<strong>a&#x3D;&#x3D;b</strong>ï¼Œé‚£ä¹ˆæ„å‘³ç€ç”±aåˆ†é…çš„å†…å­˜å¯ä»¥è¢«bé‡Šæ”¾ï¼Œåä¹‹äº¦ç„¶ï¼Œä¹Ÿå°±æ˜¯ä¸¤è€…å®Œå…¨ç­‰ä»·ã€‚å¦‚æœ<strong>a!&#x3D;b</strong>ï¼Œé‚£ä¹ˆæ„å‘³ç€aåˆ†é…çš„å†…å­˜ä¸å¯ä»¥è¢«bé‡Šæ”¾ï¼Œé€šå¸¸æƒ…å½¢æ˜¯è¿™ä¸¤ä¸ªå®ä¾‹å¤„åœ¨ä¸åŒçš„å†…å­˜ç©ºé—´ä¸”æ— æ³•äº¤æ¢ä¿¡æ¯ã€‚</p>
</li>
<li><p><strong>å®¹å™¨çš„å¤åˆ¶ã€ç§»åŠ¨å’Œäº¤æ¢å¦‚ä½•åˆ†é…å™¨çš„è¡Œä¸º</strong><br>è¿™ä¸€éƒ¨åˆ†ç•™ç»™å¤§å®¶å»é˜…è¯»æ ‡å‡†å®šä¹‰ï¼Œå¹¶äº²è‡ªè¯•ä¸€è¯•</p>
</li>
<li><p><strong>rebind</strong><br>å¯¹äºæ ‡å‡†åº“ä¸­çš„é»˜è®¤åˆ†é…å™¨<code>std::allocator</code>ï¼Œ<code>rebind</code>åœ¨C++17æ ‡å‡†ä¸­è¢«æ ‡è®°ä¸ºè¿‡æ—¶ï¼Œå¹¶åœ¨C++20æ ‡å‡†ä¸­è¢«ç§»é™¤ã€‚è¿™æ˜¯ä¸€ä¸ªå¸®åŠ©æ¨¡æ¿ç±»ï¼Œä¸€èˆ¬å®šä¹‰ä¸ºï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">U</span>&gt;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">rebind</span> &#123;</span><br><span class="line">  <span class="keyword">using</span> other = allocator&lt;U&gt;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ¨¡æ¿ç±»çš„ä½œç”¨æ˜¯å¸®åŠ©å®¹å™¨ç±»æ¥è·å–ä¸€ä¸ªä¸å…ƒç´ åˆ†é…å™¨ç±»å‹ä¸åŒçš„åˆ†é…å™¨ï¼Œä¾‹å¦‚æˆ‘ä»¬é€šå¸¸åœ¨æ„å»ºä¸€ä¸ªlistçš„æ—¶å€™ä¼šè¿™ä¹ˆå†™ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">list&lt;<span class="type">int</span>, MyAllocator&lt;<span class="type">int</span>&gt;&gt; a_list;</span><br></pre></td></tr></table></figure>
<p>ä½†æ˜¯åœ¨listçš„å®ç°å†…éƒ¨ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦ä¸€ä¸ªç‰¹æ®Šçš„ç±»<code>Node&lt;int&gt;</code>æ¥å®é™…ç®¡ç†èŠ‚ç‚¹ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦ä¸€ä¸ª<code>MyAllocator&lt;Node&lt;int&gt;&gt;</code>çš„ç±»å‹ï¼Œè¿™æ—¶å€™æƒ³å‘ç¼–è¯‘å™¨å£°æ˜æˆ‘ä»¬å¸Œæœ›å¾—åˆ°çš„è¿™ä¸ªç±»å‹å°±å¯ä»¥ä½¿ç”¨<code>rebind</code>äº†ï¼Œä¾‹å¦‚ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç‰¹åŒ–åçš„ç±»ä¸­çš„ä¸€éƒ¨åˆ†ä»£ç </span></span><br><span class="line"><span class="keyword">using</span> _Alloc = MyAllocator&lt;<span class="type">int</span>&gt;;</span><br><span class="line"><span class="keyword">using</span> _We_Want = _Alloc::rebind&lt;Node&lt;<span class="type">int</span>&gt;&gt;::other;</span><br></pre></td></tr></table></figure>
<p>è¿™æ ·å°±å®Œæˆäº†ç‹¸çŒ«æ¢å¤ªå­èˆ¬çš„ç±»å‹å£°æ˜ã€‚</p>
</li>
</ol>
<h3 id="å®é™…æ“ä½œ"><a href="#å®é™…æ“ä½œ" class="headerlink" title="å®é™…æ“ä½œ"></a>å®é™…æ“ä½œ</h3><p>é‚£ä¹ˆç°åœ¨æˆ‘ä»¬å¯ä»¥æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼Œè¿™ä¸ªä¾‹å­ä¸ä¸€å®š100%åœ¨æ‰€æœ‰æƒ…å†µä¸‹æ­£ç¡®ï¼Œåªæ˜¯ä¸ºäº†å±•ç¤ºä¸€äº›å¯èƒ½é‡åˆ°çš„å‘ï¼Œç”¨ä»¥è¯„ä»·é€‰æ‹©å®ç°è‡ªå®šä¹‰åˆ†é…å™¨æ˜¯å¦æ˜¯ä¸€æ¡åˆé€‚çš„è·¯ã€‚</p>
<h4 id="å°å¯¹è±¡ä¼˜åŒ–åˆ†é…å™¨"><a href="#å°å¯¹è±¡ä¼˜åŒ–åˆ†é…å™¨" class="headerlink" title="å°å¯¹è±¡ä¼˜åŒ–åˆ†é…å™¨"></a>å°å¯¹è±¡ä¼˜åŒ–åˆ†é…å™¨</h4><p>å‰æ–‡æåˆ°è¿‡ï¼Œåœ¨å¾ˆå¤šå®¹å™¨æˆ–è€…é¡¹ç›®é‡Œï¼Œéƒ½æœ‰é’ˆå¯¹å°å¯¹è±¡çš„ä¼˜åŒ–ç­–ç•¥ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ˜¯å¦å¯ä»¥ä¸ºæ ‡å‡†åº“çš„<code>std::vector</code>æ¥å®ç°ä¸€ä¸ªå¸¦æœ‰å°å¯¹è±¡ä¼˜åŒ–çš„è‡ªå®šä¹‰åˆ†é…å™¨å‘¢ï¼Ÿ</p>
<p>åŸºæœ¬è¡Œä¸ºå¾ˆç®€å•ï¼šåœ¨ä½¿ç”¨ä½äº8ä¸ªå…ƒç´ çš„ç©ºé—´æ—¶ï¼Œç›´æ¥ä½¿ç”¨åˆ†é…å™¨å†…ç½®çš„æ•°ç»„ç©ºé—´ï¼ˆé€šå¸¸åœ¨æ ˆä¸Šï¼‰ï¼Œè€Œåˆ†é…è¶…è¿‡8ä¸ªå…ƒç´ ç©ºé—´æ—¶é€€åŒ–ä¸ºæ™®é€šçš„åˆ†é…å™¨ã€‚ç®€å•ï¼è®©æˆ‘ä»¬æ”¹ä¸€æ”¹<code>allocate</code>å’Œ<code>deallocate</code>çš„è¡Œä¸ºå°±å¥½äº†ï¼ä¸Šä»£ç ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;type_traits&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;new&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">soo_allocator</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">using</span> value_type = T;</span><br><span class="line">    <span class="keyword">using</span> propagate_on_container_copy_assignment = std::true_type;</span><br><span class="line">    <span class="keyword">using</span> is_always_equal = std::false_type;</span><br><span class="line">    <span class="comment">// é»˜è®¤æ„é€ å‡½æ•°</span></span><br><span class="line">    <span class="built_in">soo_allocator</span>() <span class="keyword">noexcept</span> &#123;&#125;</span><br><span class="line">    <span class="comment">// é»˜è®¤å¤åˆ¶æ„é€ å‡½æ•°</span></span><br><span class="line">    <span class="built_in">soo_allocator</span>(<span class="type">const</span> soo_allocator&amp; other) <span class="keyword">noexcept</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> U&gt;</span><br><span class="line">    <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">soo_allocator</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é»˜è®¤æ¨¡æ¿å¤åˆ¶æ„é€ å‡½æ•°</span></span><br><span class="line">    <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> U&gt;</span></span><br><span class="line"><span class="function">    <span class="title">soo_allocator</span><span class="params">(<span class="type">const</span> soo_allocator&lt;U&gt;&amp; other)</span></span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç­‰ä»·æ€§æ£€æŸ¥</span></span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> U&gt;</span><br><span class="line">    <span class="type">bool</span> <span class="keyword">operator</span>==(<span class="type">const</span> soo_allocator&lt;U&gt;&amp; other) <span class="type">const</span> <span class="keyword">noexcept</span> &#123; <span class="keyword">return</span> <span class="literal">false</span>; &#125;</span><br><span class="line">    <span class="type">bool</span> <span class="keyword">operator</span>==(<span class="type">const</span> soo_allocator&amp; other) <span class="type">const</span> <span class="keyword">noexcept</span> &#123; <span class="keyword">return</span> <span class="literal">false</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¿è¯å¯¹ç§°é€»è¾‘</span></span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> U&gt;</span><br><span class="line">    <span class="type">bool</span> <span class="keyword">operator</span>!=(<span class="type">const</span> soo_allocator&lt;U&gt;&amp; other) <span class="type">const</span> <span class="keyword">noexcept</span> &#123; <span class="keyword">return</span> <span class="literal">true</span>; &#125;</span><br><span class="line">    <span class="type">bool</span> <span class="keyword">operator</span>!=(<span class="type">const</span> soo_allocator&amp; other) <span class="type">const</span> <span class="keyword">noexcept</span> &#123; <span class="keyword">return</span> <span class="literal">true</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ†é…ç­–ç•¥</span></span><br><span class="line">    <span class="function">T* <span class="title">allocate</span><span class="params">(<span class="type">const</span> <span class="type">size_t</span> n)</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (n == <span class="number">0</span>)<span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">        <span class="keyword">if</span> (n &lt;= <span class="number">8</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">reinterpret_cast</span>&lt;T*&gt;(<span class="built_in">const_cast</span>&lt;<span class="type">uint8_t</span>*&gt;(_space));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">void</span>* <span class="type">const</span> pv = <span class="built_in">malloc</span>(n * <span class="built_in">sizeof</span>(T));</span><br><span class="line">        <span class="keyword">if</span> (!pv) &#123; <span class="keyword">throw</span> std::<span class="built_in">bad_alloc</span>(); &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">static_cast</span>&lt;T*&gt;(pv);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é‡Šæ”¾ç­–ç•¥</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">deallocate</span><span class="params">(T* <span class="type">const</span> p, <span class="type">size_t</span> n)</span> <span class="type">const</span> <span class="keyword">noexcept</span> </span>&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;I&#x27;m &quot;</span> &lt;&lt; (<span class="type">void</span>*)_space &lt;&lt; <span class="string">&quot; but release &quot;</span> &lt;&lt; (<span class="type">void</span>*)p &lt;&lt; <span class="string">&quot; with &quot;</span> &lt;&lt; n &lt;&lt; <span class="string">&quot; elemets\n&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (n &lt;= <span class="number">8</span>)<span class="keyword">return</span>;</span><br><span class="line">        <span class="built_in">free</span>(p);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ææ„å‡½æ•°</span></span><br><span class="line">    ~<span class="built_in">soo_allocator</span>()&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1 ä»£ç ç‰‡</span></span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> U&gt;</span><br><span class="line">    <span class="keyword">operator</span> std::<span class="built_in">allocator</span>&lt;U&gt;() <span class="type">const</span> &#123; <span class="keyword">return</span> &#123;&#125;; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2 ä»£ç ç‰‡</span></span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> U&gt;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">rebind</span> &#123;</span><br><span class="line">        <span class="keyword">using</span> other = std::allocator&lt;U&gt;;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3 ä»£ç ç‰‡</span></span><br><span class="line">    <span class="keyword">template</span>&lt;&gt;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">rebind</span>&lt;T&gt; &#123;</span><br><span class="line">        <span class="keyword">using</span> other = soo_allocator&lt;T&gt;;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// æ‰€è°“çš„æ ˆç©ºé—´</span></span><br><span class="line">    <span class="type">uint8_t</span> _space[<span class="number">8</span> * <span class="built_in">sizeof</span>(T)];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>ğŸ†—ï¼Œæˆ‘ä»¬å¤§æ¦‚å®Œæˆäº†ä¸€ä¸ªçœ‹ä¸Šå»ä¸é”™çš„è‡ªå®šä¹‰åˆ†é…å™¨ï¼Œåœ¨åˆ†é…å’Œé‡Šæ”¾å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å®ç°äº†æˆ‘ä»¬çš„åˆ†é…ç­–ç•¥ã€‚ä½†æ˜¯ä¸‹é¢çš„ä»£ç ç‰‡1-3åˆæ˜¯ä»€ä¹ˆæ“ä½œï¼Ÿ</p>
<h4 id="å‘"><a href="#å‘" class="headerlink" title="å‘"></a>å‘</h4><p>åŠ å…¥æµ‹è¯•æ ·ä¾‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::vector&lt;<span class="type">int</span>, soo_allocator&lt;<span class="type">int</span>&gt;&gt; <span class="built_in">vec</span>(<span class="number">4</span>, <span class="number">8</span>); <span class="comment">// æ„é€ 4ä¸ª8</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> k : vec) &#123;</span><br><span class="line">        cout &lt;&lt; k &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å½“çœŸæ­£çš„å®ä¾‹åŒ–<code>std::vector&lt;int, soo_allocator&lt;int&gt;&gt;</code>æ—¶ï¼Œä¸€åˆ‡æ­£å¸¸ï¼Œä½†åœ¨ç¨‹åºé€€å‡ºæ—¶æŠ¥äº†ä¸€ä¸ªè¿è¡Œæ—¶å¼‚å¸¸ï¼ˆVS2022 Debug x64ï¼‰ï¼Œè¿™è‚¯å®šå’Œæˆ‘ä»¬çš„å†…å­˜åˆ†é…å™¨æœ‰å…³ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ¥çœ‹çœ‹åœ¨æ ‡å‡†åº“ä¸­ç©¶ç«Ÿä¼šå¦‚ä½•ä½¿ç”¨æˆ‘ä»¬æ„å»ºçš„è‡ªå®šä¹‰åˆ†é…å™¨ï¼Œè€Œå…¶ä¸­åˆæœ‰ä»€ä¹ˆçŒ«è…»ã€‚</p>
<p>æƒ³æ³•å¾ˆç¾å¥½ï¼Œç°å®å¾ˆéª¨æ„Ÿã€‚æ ‡å‡†åº“å¯¹<code>std::vector</code>çš„å®ç°å¹¶æ²¡æœ‰å’Œæˆ‘ä»¬æƒ³è±¡çš„ä¸€æ ·<em>Naive</em>ã€‚åœ¨åˆ†é…å™¨<code>allocate</code>å’Œ<code>deallocate</code>å®ç°ä¸­åŠ å…¥ä¸€äº›logä¹‹åæˆ‘ä»¬ä¼šå¾—åˆ°å¦‚ä¸‹çš„æ‰“å°ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">allocating 1 element</span><br><span class="line">allocating 4 element</span><br><span class="line">release 4 element</span><br><span class="line">release 1 element</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œé¢çš„ä¸ºä»€ä¹ˆä¼šå¤šä¸€æ¬¡åˆ†é…1ä¸ªå…ƒç´ ï¼Œè¿™æ˜¯åœ¨åˆ†é…ä»€ä¹ˆï¼Ÿ</p>
<p>è¿™é‡Œå¼•ç”¨ä¸€ç¯‡æ–‡ç« <a target="_blank" rel="noopener" href="https://blog.csdn.net/leizhengshenglzs/article/details/136263904">STLè¿­ä»£å™¨å¼•å‘çš„å´©æºƒé—®é¢˜</a>ï¼Œåšä¸»ä¹Ÿæ›¾ç»é‡åˆ°ä¸€ä¸ªSTLå´©æºƒé—®é¢˜ï¼Œç»“åˆSTLçš„æºç æˆ‘ä»¬å¯ä»¥å¾—åˆ°ä¸€ä¸ªç»“è®ºï¼š</p>
<ol>
<li>STLçš„å®ç°åœ¨Debugæ¨¡å¼ä¸‹ä¼šåŠ å…¥ä¸€äº›è¿è¡Œæ—¶å¼‚å¸¸æ£€æŸ¥ï¼Œå¦‚æœå­˜åœ¨å†…å­˜é—®é¢˜ï¼Œè¯¥æ£€æŸ¥ä¼šåŠæ—¶æŠ¥é”™ã€‚<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">if</span> _ITERATOR_DEBUG_LEVEL == 0</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure></li>
<li>é’ˆå¯¹<code>std::vector</code>æ¥è¯´ï¼Œåœ¨MSVCçš„å®ç°ä¸­ï¼Œæœ‰ä¸€ä¸ª<code>_Container_proxy</code>çš„ç±»åœ¨Debugæ¨¡å¼ä¸­è¢«å®ä¾‹åŒ–ï¼Œæ¥è®°å½•è¿­ä»£å™¨é“¾è¡¨ã€‚<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">_Container_proxy</span> &#123; <span class="comment">// store head of iterator chain and back pointer</span></span><br><span class="line">    _CONSTEXPR20 _Container_proxy() <span class="keyword">noexcept</span> = <span class="keyword">default</span>;</span><br><span class="line">    _CONSTEXPR20 _Container_proxy(_Container_base12* _Mycont_) <span class="keyword">noexcept</span> : _Mycont(_Mycont_) &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> _Container_base12* _Mycont       = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="keyword">mutable</span> _Iterator_base12* _Myfirstiter = <span class="literal">nullptr</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li>
<li>åœ¨<code>std::vector</code>çš„æ„é€ æ—¶ï¼Œä¸ºè¯¥ç±»åˆ†é…å†…å­˜çš„åˆ†é…å™¨ä¹Ÿæ˜¯æˆ‘ä»¬çš„è‡ªå®šä¹‰åˆ†é…å™¨ã€‚æ³¨æ„ä»£ç ä¸­ä½¿ç”¨äº†å‰æ–‡æåˆ°çš„<code>rebind</code>æŠ€æœ¯ï¼Œå¹¶è·å¾—äº†ç±»åä¸º<code>soo_allocator&lt;_Container_proxy&gt;</code>çš„åˆ†é…å™¨ã€‚STLä½¿ç”¨è¯¥åˆ†é…å™¨åˆ†é…äº†1ä¸ªå…ƒç´ ç©ºé—´æ¥å­˜å‚¨è¿­ä»£å™¨.<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _GET_PROXY_ALLOCATOR(_Alty, _Al) static_cast<span class="string">&lt;_Rebind_alloc_t&lt;_Alty, _Container_proxy&gt;</span>&gt;(_Al)</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Alloc</span>&gt;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">_Container_proxy_ptr12</span> : _Basic_container_proxy_ptr12 &#123;</span><br><span class="line">    <span class="comment">// smart pointer components for a _Container_proxy * for an allocator family</span></span><br><span class="line">    _Alloc&amp; _Al;</span><br><span class="line"></span><br><span class="line">    _CONSTEXPR20 _Container_proxy_ptr12(_Alloc&amp; _Al_, _Leave_proxy_unbound) : _Al(_Al_) &#123;</span><br><span class="line">        <span class="comment">// create a new unbound _Container_proxy</span></span><br><span class="line">        _Ptr = _Unfancy(_Al_.<span class="built_in">allocate</span>(<span class="number">1</span>));</span><br><span class="line">        _Construct_in_place(*_Ptr);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li>
<li>åœ¨æ„é€ æ—¶<code>soo_allocator&lt;_Container_proxy&gt;</code>çš„å®ä¾‹ä¸ºä¸´æ—¶å¯¹è±¡ï¼Œæ„é€ ç»“æŸåå°±è¢«ææ„å›æ”¶ã€‚è¿™é‡Œé—®é¢˜å°±æ¥äº†ï¼Œæˆ‘ä»¬çš„<code>soo_allocator</code>çš„å†…å­˜åˆ†é…åœ¨æ ˆä¸Šï¼Œä¸€æ—¦å‡ºæ ˆï¼Œè¯¥ç©ºé—´å°±è¢«ä¸¢æ‰äº†ï¼Œè€Œä¸Šé¢çš„è¿­ä»£å™¨ä¿¡æ¯è¿˜æ²¡æœ‰è¢«æ­£ç¡®ææ„å‘¢ï¼å½“<code>std::vector</code>ç»“æŸè‡ªå·±çš„ç”Ÿå‘½å‘¨æœŸå‡†å¤‡<code>clear()</code>çš„æ—¶å€™â€œ<code>_Container_proxy </code>ä¸Šé¢è®°å½•çš„è¿™ä¸ªè¿­ä»£å™¨æŒ‡é’ˆå°±å˜æˆäº†ä¸€ä¸ªé‡æŒ‡é’ˆâ€ï¼Œä»è€Œé€ æˆäº†éæ³•è®¿é—®è€Œå¼•èµ·å´©æºƒã€‚</li>
</ol>
<h4 id="é­”æ”¹ä»£ç ç‰‡"><a href="#é­”æ”¹ä»£ç ç‰‡" class="headerlink" title="é­”æ”¹ä»£ç ç‰‡"></a>é­”æ”¹ä»£ç ç‰‡</h4><p>ä»£ç ç‰‡1-3æ˜¯ä¸€ç§ä¸æ­£è§„çš„hackæ‰‹æ®µã€‚</p>
<p>é¦–å…ˆæˆ‘ä»¬æ³¨æ„åˆ°ï¼Œä¸ºäº†é¿å…è¿­ä»£å™¨æ£€æŸ¥é”™è¯¯åˆ†é…ç©ºé—´ï¼Œæˆ‘ä»¬éœ€è¦åœ¨åˆ†é…è¯¥è¿­ä»£å™¨é“¾è¡¨æ—¶ä½¿ç”¨é€€åŒ–çš„æ™®é€šåˆ†é…å™¨ï¼Œè¿™å¯ä»¥é€šè¿‡<strong>ä»£ç ç‰‡2</strong>é­”æ”¹<code>rebind</code>æœºåˆ¶æ¥å®ç°ã€‚é€šè¿‡ä¿®æ”¹<code>rebind</code>çš„ç±»å‹å£°æ˜ï¼Œä½¿å¾—é€šè¿‡<code>rebind</code>æ¥åå°„æ¨¡æ¿ç±»å‹çš„æ—¶å€™å®é™…æ‹¿åˆ°çš„æ˜¯<code>std::allocator&lt;_Container_proxy&gt;</code>ï¼Œä½¿å¾—è¿­ä»£å™¨é“¾è¡¨èƒ½ä»¥é€šå¸¸çš„æ–¹å¼åˆ†é…å’Œé‡Šæ”¾ã€‚</p>
<p>å…¶æ¬¡ä¸ºäº†é˜²æ­¢å½±å“åˆ°æ¨¡æ¿ç±»ä¸º<code>int</code>çš„å…¶ä»–åå°„è°ƒç”¨ï¼Œæˆ‘ä»¬éœ€è¦<strong>ä»£ç ç‰‡3</strong>ç‰¹åŒ–<code>rebind</code>æ¨¡æ¿ç±»å‹ï¼Œå½“æ£€æŸ¥åˆ°éœ€è¦<code>rebind</code>çš„ç±»å‹å’ŒåŸå§‹ç±»å‹<code>T</code>ä¸€è‡´æ—¶ï¼Œæˆ‘ä»¬ä¾ç„¶è¿”å›<code>soo_allocator&lt;T&gt;</code>æ¥ä¿è¯è¡Œä¸ºæ­£ç¡®ï¼Œä¸€è‡´ã€‚</p>
<p>æœ€åæˆ‘ä»¬æ³¨æ„åˆ°ï¼ŒSTLåœ¨æ„é€ <code>soo_allocator&lt;_Container_proxy&gt;</code>æ—¶ä¼ å…¥çš„å‚æ•°å®é™…ä¸Šæ˜¯<code>soo_allocator&lt;int&gt;</code>ï¼Œæˆ‘ä»¬éœ€è¦<strong>ä»£ç ç‰‡1</strong>ä¸€ä¸ªç±»å‹è½¬æ¢æ“ä½œç¬¦æ¥å®ç°è¿™ä¸ªæ„é€ è¿‡ç¨‹ã€‚</p>
<p>åœ¨å®Œæˆè¿™äº›è®¸å¤§åŠ›å‡ºå¥‡è¿¹ä¹‹åï¼Œæˆ‘ä»¬ç»ˆäºè·å¾—äº†ä¸€ä¸ªå¯ä»¥ç¼–è¯‘å¹¶åœ¨Debugæ¨¡å¼ä¸‹æ­£å¸¸è¿è¡Œçš„ç¨‹åºã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æ ¹æ®ä»¥ä¸Šåˆ†æï¼Œ<code>allocator</code>çš„è®¾è®¡æ€æƒ³æ˜¯éå¸¸å¥½çš„ï¼Œæ ‡å‡†åº“ä¹Ÿåšäº†å¾ˆå¤šåŠªåŠ›ï¼Œè®©å…¶é€»è¾‘è‡ªæ´½å¹¶å°½å¯èƒ½çµæ´»å¥½ç”¨ï¼Œä½†æƒ³è®¾è®¡ä¸€ä¸ªçœŸæ­£çµæ´»çš„æ»¡è¶³æ ‡å‡†åº“å®¹å™¨çš„åˆ†é…å™¨å¹¶ä¸å®¹æ˜“ï¼Œç”šè‡³å…¶è¡Œä¸ºä¸å…·ä½“STLçš„å®ç°æ–¹å¼ç›¸å…³ï¼Œç¼–å†™C++ç¨‹åºçš„ç¨‹åºå‘˜æ— è®ºå¦‚ä½•éƒ½ä¸æƒ³å»å‚é€è¾£çœ¼ç›çš„STLæºç ï¼Œè¿™ä¹Ÿä¸æ˜¯æ­£å¸¸çš„äº§å“ç»´æŠ¤é€»è¾‘ã€‚å¦‚ç¤¾åŒºå†…é•¿ä¹…çš„è®¨è®ºä¸€æ ·ï¼Œä¼¼ä¹æƒ³å¾—åˆ°ä¸€ä¸ªå®Œç¾çš„è®¾è®¡æ€æƒ³éå¸¸å›°éš¾ï¼Œä¾‹å¦‚ï¼š</p>
<blockquote>
<p>åœ¨â€œè‡ªå®šä¹‰åˆ†é…å™¨â€è¿™ä¸€è¯é¢˜ä¸Šï¼Œå·²æœ‰è¯¸å¤šC++ä¸“å®¶ä¸ç›¸å…³ä½œè€…å‚ä¸æ¢è®¨ï¼Œä¾‹å¦‚æ–¯ç§‘ç‰¹Â·æ¢…è€¶æ–¯çš„ä½œå“ã€ŠEffective STLã€‹ä¸å®‰å¾·çƒˆÂ·äºšå†å±±å¾·é›·æ–¯åº“çš„ã€ŠModern C++ Designã€‹éƒ½æœ‰æåŠã€‚æ¢…è€¶æ–¯æ´å¯Ÿåˆ°ï¼Œè‹¥è¦æ±‚é’ˆå¯¹æŸä¸€ç±»å‹Tçš„åˆ†é…å™¨çš„æ‰€æœ‰å®ä¾‹éƒ½ç›¸ç­‰ï¼Œåˆ™å¯ç§»æ¤çš„åˆ†é…å™¨çš„å®ä¾‹å¿…é¡»ä¸åŒ…å«çŠ¶æ€ã€‚è™½ç„¶C++æ ‡å‡†é¼“åŠ±åº“çš„å®ç°è€…æ”¯æŒå¸¦çŠ¶æ€çš„åˆ†é…å™¨ï¼Œä½†æ¢…è€¶æ–¯ç§°ï¼Œç›¸å…³æ®µè½æ˜¯â€œï¼ˆçœ‹ä¼¼ï¼‰ç¾å¦™çš„è§‚ç‚¹â€ï¼Œä½†ä¹Ÿå‡ ä¹æ˜¯ç©ºè¯ï¼Œå¹¶ç§°åˆ†é…å™¨çš„é™åˆ¶â€œè¿‡äºä¸¥è‹›â€ã€‚ä¾‹å¦‚ï¼ŒSTLçš„listå…è®¸spliceæ–¹æ³•ï¼Œå³ä¸€ä¸ªlistå¯¹è±¡Açš„èŠ‚ç‚¹å¯ä»¥è¢«ç›´æ¥ç§»å…¥å¦ä¸€ä¸ªlistå¯¹è±¡Bä¸­ï¼Œè¿™å°±è¦æ±‚Açš„åˆ†é…å™¨ç”³è¯·åˆ°çš„å†…å­˜ï¼Œå¯è¢«Bçš„åˆ†é…å™¨é‡Šæ”¾æ‰ï¼Œä»è€Œæ¨å¯¼å‡ºAä¸Bçš„åˆ†é…å™¨å®ä¾‹å¿…é¡»ç›¸ç­‰ã€‚æ¢…è€¶æ–¯çš„ç»“è®ºæ˜¯ï¼Œåˆ†é…å™¨æœ€å¥½å®šä¹‰ä¸ºä½¿ç”¨é™æ€æ–¹æ³•çš„ç±»å‹ã€‚ä¾‹å¦‚ï¼Œæ ¹æ®C++æ ‡å‡†ï¼Œåˆ†é…å™¨å¿…é¡»æä¾›ä¸€ä¸ªå®ç°äº†rebindæ–¹æ³•çš„otherç±»æ¨¡æ¿ã€‚<br>å¦å¤–ï¼Œåœ¨ã€ŠC++ç¨‹åºè®¾è®¡è¯­è¨€ã€‹ä¸­ï¼Œæ¯”é›…å°¼Â·æ–¯ç‰¹åŠ³æ–¯ç‰¹é²æ™®åˆ™è®¤ä¸ºâ€œâ€˜ä¸¥æ ¼é™åˆ¶åˆ†é…å™¨ï¼Œä»¥å…å„å¯¹è±¡ä¿¡æ¯ä¸åŒâ€™ï¼Œè¿™ç‚¹æ˜¾ç„¶é—®é¢˜ä¸å¤§â€ï¼ˆå¤§æ„ï¼‰ï¼Œå¹¶æŒ‡å‡ºå¤§éƒ¨åˆ†åˆ†é…å™¨å¹¶ä¸éœ€è¦çŠ¶æ€ï¼Œç”šè‡³æ²¡æœ‰çŠ¶æ€æƒ…å½¢ä¸‹æ€§èƒ½åå€’æ›´ä½³ã€‚ä»–æå‡ºäº†ä¸‰ä¸ªè‡ªå®šä¹‰åˆ†é…å™¨çš„ç”¨ä¾‹ï¼šå†…å­˜æ± å‹çš„åˆ†é…å™¨ã€å…±äº«å†…å­˜å‹åˆ†é…å™¨ä¸åƒåœ¾å›æ”¶å‹åˆ†é…å™¨ï¼Œå¹¶å±•ç¤ºäº†ä¸€ä¸ªåˆ†é…å™¨çš„å®ç°ï¼Œæ­¤é—´åˆ©ç”¨äº†ä¸€ä¸ªå†…éƒ¨å†…å­˜æ± ï¼Œä»¥å¿«é€Ÿåˆ†é…&#x2F;è§£é™¤åˆ†é…å°‘é‡å†…å­˜ã€‚ä½†ä»–ä¹Ÿæåˆ°ï¼Œå¦‚æ­¤ä¼˜åŒ–å¯èƒ½å·²ç»åœ¨ä»–æ‰€æä¾›çš„æ ·ä¾‹åˆ†é…å™¨ä¸­å®ç°ã€‚</p>
</blockquote>
<p>å¸Œæœ›ä»¥ä¸Šçš„è®¨è®ºèƒ½ç»™å¼€å‘å¸¦æ¥ä¸€äº›æ€è€ƒå’Œæç¤ºï¼Œä½¿<code>allocator</code>çœŸæ­£å‘æŒ¥å‡ºå®ƒçš„ä»·å€¼æ‰€åœ¨ã€‚</p>

      </div>
      
        <div class="prev-or-next">
          <div class="post-foot-next">
            
              <a href="/2023/10/28/surround-view-survey/" target="_self">
                <i class="iconfont icon-chevronleft"></i>
                <span>Prev</span>
              </a>
            
          </div>
          <div class="post-attach">
            <span class="post-pubtime">
              <i class="iconfont icon-updatetime mr-10" title="Update time"></i>
              2024-06-12 21:19:21
            </span>
            
                  <span class="post-tags">
                    <i class="iconfont icon-tags mr-10" title="Tags"></i>
                    
                    <span class="span--tag mr-8">
                      <a href="/tags/Modern-C/" title="Modern C++">
                        #Modern C++
                      </a>
                    </span>
                    
                    <span class="span--tag mr-8">
                      <a href="/tags/Memory-manage/" title="Memory manage">
                        #Memory manage
                      </a>
                    </span>
                    
                  </span>
              
          </div>
          <div class="post-foot-prev">
            
          </div>
        </div>
      
    </div>
    
  <div id="btn-catalog" class="btn-catalog">
    <i class="iconfont icon-catalog"></i>
  </div>
  <div class="post-catalog hidden" id="catalog">
    <div class="title">Contents</div>
    <div class="catalog-content">
      
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#C-%E6%A0%87%E5%87%86%E5%BA%93%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E5%99%A8%E5%92%8C%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E5%99%A8%E7%89%B9%E6%80%A7"><span class="toc-text">C++ æ ‡å‡†åº“å†…å­˜åˆ†é…å™¨å’Œå†…å­˜åˆ†é…å™¨ç‰¹æ€§</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%95%E8%A8%80"><span class="toc-text">å¼•è¨€</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%86%E5%8F%B2"><span class="toc-text">å†å²</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%98%E5%8A%BF"><span class="toc-text">ä¼˜åŠ¿</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%85%A5%E6%89%8B"><span class="toc-text">å¦‚ä½•å…¥æ‰‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8EC-17-std-allocator-traits-%E5%87%BA%E5%8F%91"><span class="toc-text">ä»C++17 std::allocator_traits å‡ºå‘</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%A8%E8%AE%BA"><span class="toc-text">è®¨è®º</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E9%99%85%E6%93%8D%E4%BD%9C"><span class="toc-text">å®é™…æ“ä½œ</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%8F%E5%AF%B9%E8%B1%A1%E4%BC%98%E5%8C%96%E5%88%86%E9%85%8D%E5%99%A8"><span class="toc-text">å°å¯¹è±¡ä¼˜åŒ–åˆ†é…å™¨</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9D%91"><span class="toc-text">å‘</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%AD%94%E6%94%B9%E4%BB%A3%E7%A0%81%E7%89%87"><span class="toc-text">é­”æ”¹ä»£ç ç‰‡</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-text">æ€»ç»“</span></a></li></ol>
      
    </div>
  </div>

  
<script src="/js/catalog.js"></script>




    
      <div class="comments-container">
        







      </div>
    
  </div>


        
<div class="footer">
  <div class="social">
    <ul>
      
        <li>
          <a title="github" target="_blank" rel="noopener" href="https://github.com/baizebing">
            <i class="iconfont icon-github"></i>
          </a>
        </li>
      
    </ul>
  </div>
  
    
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/baizebing">Copyright Â© 2024 Cris Bai</a>
        
    </div>
  
    
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/zchengsite/hexo-theme-oranges">Theme by Oranges | Powered by Hexo</a>
        
    </div>
  
  
</div>

      </div>

      <div class="tools-bar">
        <div class="back-to-top tools-bar-item hidden">
  <a href="javascript: void(0)">
    <i class="iconfont icon-chevronup"></i>
  </a>
</div>


<script src="/js/backtotop.js"></script>



        
  <div class="search-icon tools-bar-item" id="search-icon">
    <a href="javascript: void(0)">
      <i class="iconfont icon-search"></i>
    </a>
  </div>

  <div class="search-overlay hidden">
    <div class="search-content" tabindex="0">
      <div class="search-title">
        <span class="search-icon-input">
          <a href="javascript: void(0)">
            <i class="iconfont icon-search"></i>
          </a>
        </span>
        
          <input type="text" class="search-input" id="search-input" placeholder="Search...">
        
        <span class="search-close-icon" id="search-close-icon">
          <a href="javascript: void(0)">
            <i class="iconfont icon-close"></i>
          </a>
        </span>
      </div>
      <div class="search-result" id="search-result"></div>
    </div>
  </div>

  <script type="text/javascript">
    var inputArea = document.querySelector("#search-input")
    var searchOverlayArea = document.querySelector(".search-overlay")

    inputArea.onclick = function() {
      getSearchFile()
      this.onclick = null
    }

    inputArea.onkeydown = function() {
      if(event.keyCode == 13)
        return false
    }

    function openOrHideSearchContent() {
      let isHidden = searchOverlayArea.classList.contains('hidden')
      if (isHidden) {
        searchOverlayArea.classList.remove('hidden')
        document.body.classList.add('hidden')
        // inputArea.focus()
      } else {
        searchOverlayArea.classList.add('hidden')
        document.body.classList.remove('hidden')
      }
    }

    function blurSearchContent(e) {
      if (e.target === searchOverlayArea) {
        openOrHideSearchContent()
      }
    }

    document.querySelector("#search-icon").addEventListener("click", openOrHideSearchContent, false)
    document.querySelector("#search-close-icon").addEventListener("click", openOrHideSearchContent, false)
    searchOverlayArea.addEventListener("click", blurSearchContent, false)

    var searchFunc = function (path, search_id, content_id) {
      'use strict';
      var $input = document.getElementById(search_id);
      var $resultContent = document.getElementById(content_id);
      $resultContent.innerHTML = "<ul><span class='local-search-empty'>First search, index file loading, please wait...<span></ul>";
      $.ajax({
        // 0x01. load xml file
        url: path,
        dataType: "xml",
        success: function (xmlResponse) {
          // 0x02. parse xml file
          var datas = $("entry", xmlResponse).map(function () {
            return {
              title: $("title", this).text(),
              content: $("content", this).text(),
              url: $("url", this).text()
            };
          }).get();
          $resultContent.innerHTML = "";

          $input.addEventListener('input', function () {
            // 0x03. parse query to keywords list
            var str = '<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length <= 0) {
              return;
            }
            // 0x04. perform local searching
            datas.forEach(function (data) {
              var isMatch = true;
              var content_index = [];
              if (!data.title || data.title.trim() === '') {
                data.title = "Untitled";
              }
              var orig_data_title = data.title.trim();
              var data_title = orig_data_title.toLowerCase();
              var orig_data_content = data.content.trim().replace(/<[^>]+>/g, "");
              var data_content = orig_data_content.toLowerCase();
              var data_url = data.url;
              var index_title = -1;
              var index_content = -1;
              var first_occur = -1;
              // only match artiles with not empty contents
              if (data_content !== '') {
                keywords.forEach(function (keyword, i) {
                  index_title = data_title.indexOf(keyword);
                  index_content = data_content.indexOf(keyword);

                  if (index_title < 0 && index_content < 0) {
                    isMatch = false;
                  } else {
                    if (index_content < 0) {
                      index_content = 0;
                    }
                    if (i == 0) {
                      first_occur = index_content;
                    }
                    // content_index.push({index_content:index_content, keyword_len:keyword_len});
                  }
                });
              } else {
                isMatch = false;
              }
              // 0x05. show search results
              if (isMatch) {
                str += "<li><a href='" + data_url + "' class='search-result-title'>" + orig_data_title + "</a>";
                var content = orig_data_content;
                if (first_occur >= 0) {
                  // cut out 100 characters
                  var start = first_occur - 20;
                  var end = first_occur + 80;

                  if (start < 0) {
                    start = 0;
                  }

                  if (start == 0) {
                    end = 100;
                  }

                  if (end > content.length) {
                    end = content.length;
                  }

                  var match_content = content.substr(start, end);

                  // highlight all keywords
                  keywords.forEach(function (keyword) {
                    var regS = new RegExp(keyword, "gi");
                    match_content = match_content.replace(regS, "<span class=\"search-keyword\">" + keyword + "</span>");
                  });

                  str += "<p class=\"search-result-abstract\">" + match_content + "...</p>"
                }
                str += "</li>";
              }
            });
            str += "</ul>";
            if (str.indexOf('<li>') === -1) {
              return $resultContent.innerHTML = "<ul><span class='local-search-empty'>No result<span></ul>";
            }
            $resultContent.innerHTML = str;
          });
        },
        error: function(xhr, status, error) {
          $resultContent.innerHTML = ""
          if (xhr.status === 404) {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>The search.xml file was not found, please refer toï¼š<a href='https://github.com/zchengsite/hexo-theme-oranges#configuration' target='_black'>configuration</a><span></ul>";
          } else {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>The request failed, Try to refresh the page or try again later.<span></ul>";
          }
        }
      });
      $(document).on('click', '#search-close-icon', function() {
        $('#search-input').val('');
        $('#search-result').html('');
      });
    }

    var getSearchFile = function() {
        var path = "/search.xml";
        searchFunc(path, 'search-input', 'search-result');
    }
  </script>




        
  <div class="tools-bar-item theme-icon" id="switch-color-scheme">
    <a href="javascript: void(0)">
      <i id="theme-icon" class="iconfont icon-moon"></i>
    </a>
  </div>

  
<script src="/js/colorscheme.js"></script>





        
  
    <div class="share-icon tools-bar-item">
      <a href="javascript: void(0)" id="share-icon">
        <i class="iconfont iconshare"></i>
      </a>
      <div class="share-content hidden">
        
          <a class="share-item" href="https://twitter.com/intent/tweet?text=' + C%2B%2B%20Allocator + '&url=' + http%3A%2F%2Fexample.com%2F2024%2F06%2F12%2FCpp-Allocator%2F + '" target="_blank" title="Twitter">
            <i class="iconfont icon-twitter"></i>
          </a>
        
        
          <a class="share-item" href="https://www.facebook.com/sharer.php?u=http://example.com/2024/06/12/Cpp-Allocator/" target="_blank" title="Facebook">
            <i class="iconfont icon-facebooksquare"></i>
          </a>
        
      </div>
    </div>
  
  
<script src="/js/shares.js"></script>



      </div>
    </div>
  </body>
</html>
